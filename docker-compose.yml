version: "3.9"

services:
  # --- MongoDB ---
  mongodb:
    image: mongo:7.0
    container_name: mongodb
    hostname: mongodb
    ports:
      - "27018:27017"
    volumes:
      - ./data/mongodb-data:/data/db
    environment:
      MONGO_INITDB_DATABASE: edu_analytics
    networks:
      - edu-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # --- PostgreSQL ---
  postgres:
    image: postgres:16
    container_name: postgre
    hostname: postgres
    environment:
      POSTGRES_DB: edu
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"
    volumes:
      - ./data/pg-data:/var/lib/postgresql/data
      - ./backend/migrations/001_initial_schema.sql:/docker-entrypoint-initdb.d/001_initial_schema.sql:ro
    networks:
      - edu-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d edu"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # --- ChromaDB Vector Database ---
  chromadb:
    image: ghcr.io/chroma-core/chroma:0.4.24
    container_name: chromadb
    hostname: chromadb
    ports:
      - "8000:8000"  # Internal port 8000, mapped to external 8000
    environment:
      - CHROMA_SERVER_AUTH=False
      - IS_PERSISTENT=True
      - ALLOW_RESET=True
      - ANONYMIZED_TELEMETRY=False
    volumes:
      - ./data/chroma-data:/chroma/chroma
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8000/api/v1/heartbeat').read()\" || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 8
      start_period: 30s
    networks:
      - edu-network
    restart: unless-stopped

  # --- Node.js Backend ---
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: nodejs-backend
    hostname: backend
    environment:
      NODE_ENV: production
      PORT: 8080
      JWT_SECRET: supersecretkey
      JWT_EXPIRES_IN: 7d
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: edu
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: password
      MONGODB_URI: mongodb://mongodb:27017/edu_analytics
      MAX_FILE_SIZE: 10485760
    depends_on:
      postgres:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    ports:
      - "8080:8080"
    volumes:
      - ./backend/uploads:/app/uploads
    networks:
      - edu-network
    restart: unless-stopped

  # --- React Frontend ---
  frontend:
    build:
      context: ./edu-frontend
      dockerfile: Dockerfile
    container_name: react-frontend
    hostname: frontend
    depends_on:
      - backend
    ports:
      - "5173:5173"
    environment:
      - VITE_API_URL=http://localhost:8080/api
      - VITE_UPLOAD_SERVICE_URL=http://localhost:8001
      - VITE_CO_GENERATOR_URL=http://localhost:8002
      - VITE_RECOMMENDATION_SERVICE_URL=http://localhost:8003
      - VITE_DBMS_RECOMMENDER_URL=http://localhost:8004
    networks:
      - edu-network
    restart: unless-stopped

  # --- FastAPI Upload Service (CSV/XLSX â†’ PostgreSQL) ---
  upload-service:
    build:
      context: ./upload-service
      dockerfile: Dockerfile
    container_name: fastapi_upload_service
    hostname: upload-service
    ports:
      - "8001:8001"
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: password
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: edu
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - edu-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8001/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # --- Neo4j Database (for CO Generator Knowledge Graph) ---
  neo4j:
    image: neo4j:5.15.0
    container_name: co-generator-neo4j
    hostname: neo4j
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    environment:
      - NEO4J_AUTH=neo4j/cogenerator123
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_memory_heap_initial__size=512m
      - NEO4J_dbms_memory_heap_max__size=2G
    volumes:
      - ./data/neo4j-data:/data
      - ./data/neo4j-logs:/logs
      - ./data/neo4j-import:/var/lib/neo4j/import
    healthcheck:
      test: ["CMD-SHELL", "wget -O - http://localhost:7474 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - edu-network
    restart: unless-stopped

  # --- CO Generator FastAPI Service ---
  co-generator:
    build:
      context: ./CO-generator
      dockerfile: Dockerfile
    container_name: co-generator-backend
    hostname: co-generator
    ports:
      - "8002:8000"
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=cogenerator123
      - PYTHONUNBUFFERED=1
    volumes:
      - ./CO-generator/data:/app/data
      - ./CO-generator/src:/app/src
      - ./CO-generator/qwen_co_lora:/app/qwen_co_lora
      - ./CO-generator/gptneo_co_lora:/app/gptneo_co_lora
    depends_on:
      neo4j:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - edu-network
    restart: unless-stopped
    command: python -m uvicorn src.fastapi:app --host 0.0.0.0 --port 8000 --reload

  # --- Recommendation System FastAPI Service ---
  recommendation-service:
    build:
      context: ./recommendation-service
      dockerfile: Dockerfile
    container_name: recommendation-service
    hostname: recommendation-service
    ports:
      - "8003:8003"
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - ENVIRONMENT=production
      - BACKEND_API_URL=http://backend:8080/api
      - LOG_LEVEL=INFO
    volumes:
      - ./recommendation-service/data:/app/data
      - ./recommendation-service/logs:/app/logs
      - ./recommendation-service/models_cache:/app/models_cache
    depends_on:
      backend:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8003/health').read()\" || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - edu-network
    restart: unless-stopped

  # --- DBMS Resource Recommender Service ---
  dbms-recommender:
    build:
      context: ./res_system_streamlit
      dockerfile: Dockerfile
    container_name: dbms-recommender
    hostname: dbms-recommender
    ports:
      - "8004:8004"
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - PORT=8004
    volumes:
      - ./res_system_streamlit/data:/app/data
      - ./res_system_streamlit/logs:/app/logs
    networks:
      - edu-network
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8004/health').read()\" || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped


# --- Persistent Volumes ---
volumes:
  mongodb-data:
  pg-data:
  chroma-data:
  neo4j-data:
  neo4j-logs:
  neo4j-import:

# --- Shared Network ---
networks:
  edu-network:
    driver: bridge
